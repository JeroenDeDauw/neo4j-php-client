
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Handlers and Middleware &#8212; Neo4j PHP Client and Driver</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/guzzle.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Neo4j PHP Client and Driver</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Handlers and Middleware</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    index.html" class="text-logo">Neo4j PHP Client and Driver</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing Guzzle Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Handlers and Middleware</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <section id="handlers-and-middleware">
<h1>Handlers and Middleware<a class="headerlink" href="#handlers-and-middleware" title="Permalink to this heading">¶</a></h1>
<p>Guzzle clients use a handler and middleware system to send HTTP requests.</p>
<section id="handlers">
<h2>Handlers<a class="headerlink" href="#handlers" title="Permalink to this heading">¶</a></h2>
<p>A handler function accepts a <code class="docutils literal notranslate"><span class="pre">Psr\Http\Message\RequestInterface</span></code> and array of
request options and returns a <code class="docutils literal notranslate"><span class="pre">GuzzleHttp\Promise\PromiseInterface</span></code> that is
fulfilled with a <code class="docutils literal notranslate"><span class="pre">Psr\Http\Message\ResponseInterface</span></code> or rejected with an
exception.</p>
<p>You can provide a custom handler to a client using the <code class="docutils literal notranslate"><span class="pre">handler</span></code> option of
a client constructor. It is important to understand that several request
options used by Guzzle require that specific middlewares wrap the handler used
by the client. You can ensure that the handler you provide to a client uses the
default middlewares by wrapping the handler in the
<code class="docutils literal notranslate"><span class="pre">GuzzleHttp\HandlerStack::create(callable</span> <span class="pre">$handler</span> <span class="pre">=</span> <span class="pre">null)</span></code> static method.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>

<span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">();</span>
<span class="nv">$stack</span> <span class="o">=</span> <span class="nx">HandlerStack</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span> <span class="c1">// Wrap w/ middleware</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create</span></code> method adds default handlers to the <code class="docutils literal notranslate"><span class="pre">HandlerStack</span></code>. When the
<code class="docutils literal notranslate"><span class="pre">HandlerStack</span></code> is resolved, the handlers will execute in the following order:</p>
<ol class="arabic simple">
<li><p>Sending request:</p></li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">http_errors</span></code> - No op when sending a request. The response status code
is checked in the response processing when returning a response promise up
the stack.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allow_redirects</span></code> - No op when sending a request. Following redirects
occurs when a response promise is being returned up the stack.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cookies</span></code> - Adds cookies to requests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prepare_body</span></code> - The body of an HTTP request will be prepared (e.g.,
add default headers like Content-Length, Content-Type, etc.).</p></li>
<li><p>&lt;send request with handler&gt;</p></li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Processing response:</p></li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">prepare_body</span></code> - no op on response processing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cookies</span></code> - extracts response cookies into the cookie jar.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allow_redirects</span></code> - Follows redirects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">http_errors</span></code> - throws exceptions when the response status code <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code>
400.</p></li>
</ol>
</div></blockquote>
<p>When provided no <code class="docutils literal notranslate"><span class="pre">$handler</span></code> argument, <code class="docutils literal notranslate"><span class="pre">GuzzleHttp\HandlerStack::create()</span></code>
will choose the most appropriate handler based on the extensions available on
your system.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The handler provided to a client determines how request options are applied
and utilized for each request sent by a client. For example, if you do not
have a cookie middleware associated with a client, then setting the
<code class="docutils literal notranslate"><span class="pre">cookies</span></code> request option will have no effect on the request.</p>
</div>
</section>
<section id="middleware">
<h2>Middleware<a class="headerlink" href="#middleware" title="Permalink to this heading">¶</a></h2>
<p>Middleware augments the functionality of handlers by invoking them in the
process of generating responses. Middleware is implemented as a higher order
function that takes the following form.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">my_middleware</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">callable</span> <span class="nv">$handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$handler</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Middleware functions return a function that accepts the next handler to invoke.
This returned function then returns another function that acts as a composed
handler– it accepts a request and options, and returns a promise that is
fulfilled with a response. Your composed middleware can modify the request,
add custom request options, and modify the promise returned by the downstream
handler.</p>
<p>Here’s an example of adding a header to each request.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">add_header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">callable</span> <span class="nv">$handler</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span>
            <span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span>
            <span class="k">array</span> <span class="nv">$options</span>
        <span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$handler</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once a middleware has been created, you can add it to a client by either
wrapping the handler used by the client or by decorating a handler stack.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">add_header</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">));</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>Now when you send a request, the client will use a handler composed with your
added middleware, adding a header to each request.</p>
<p>Here’s an example of creating a middleware that modifies the response of the
downstream handler. This example adds a header to the response.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">add_response_header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">callable</span> <span class="nv">$handler</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span>
            <span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span>
            <span class="k">array</span> <span class="nv">$options</span>
        <span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$promise</span> <span class="o">=</span> <span class="nv">$handler</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$promise</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span>
                <span class="k">function</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">add_response_header</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">));</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>Creating a middleware that modifies a request is made much simpler using the
<code class="docutils literal notranslate"><span class="pre">GuzzleHttp\Middleware::mapRequest()</span></code> middleware. This middleware accepts
a function that takes the request argument and returns the request to send.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">}));</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>Modifying a response is also much simpler using the
<code class="docutils literal notranslate"><span class="pre">GuzzleHttp\Middleware::mapResponse()</span></code> middleware.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapResponse</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">}));</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
</section>
<section id="handlerstack">
<h2>HandlerStack<a class="headerlink" href="#handlerstack" title="Permalink to this heading">¶</a></h2>
<p>A handler stack represents a stack of middleware to apply to a base handler
function. You can push middleware to the stack to add to the top of the stack,
and unshift middleware onto the stack to add to the bottom of the stack. When
the stack is resolved, the handler is pushed onto the stack. Each value is
then popped off of the stack, wrapping the previous value popped off of the
stack.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Utils</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="nx">Utils</span><span class="o">::</span><span class="na">chooseHandler</span><span class="p">());</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;A&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">}));</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;B&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">}));</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;C&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">}));</span>

<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;http://httpbin.org/&#39;</span><span class="p">);</span>
<span class="c1">// echoes &#39;ABC&#39;;</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">unshift</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">}));</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;http://httpbin.org/&#39;</span><span class="p">);</span>
<span class="c1">// echoes &#39;0ABC&#39;;</span>
</pre></div>
</div>
<p>You can give middleware a name, which allows you to add middleware before
other named middleware, after other named middleware, or remove middleware
by name.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>

<span class="c1">// Add a middleware with a name</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">);</span>
<span class="p">},</span> <span class="s1">&#39;add_foo&#39;</span><span class="p">));</span>

<span class="c1">// Add a middleware before a named middleware (unshift before).</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="s1">&#39;add_foo&#39;</span><span class="p">,</span> <span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Baz&#39;</span><span class="p">,</span> <span class="s1">&#39;Qux&#39;</span><span class="p">);</span>
<span class="p">},</span> <span class="s1">&#39;add_baz&#39;</span><span class="p">));</span>

<span class="c1">// Add a middleware after a named middleware (pushed after).</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">after</span><span class="p">(</span><span class="s1">&#39;add_baz&#39;</span><span class="p">,</span> <span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Lorem&#39;</span><span class="p">,</span> <span class="s1">&#39;Ipsum&#39;</span><span class="p">);</span>
<span class="p">}));</span>

<span class="c1">// Remove a middleware by name</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="s1">&#39;add_foo&#39;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="creating-a-handler">
<h2>Creating a Handler<a class="headerlink" href="#creating-a-handler" title="Permalink to this heading">¶</a></h2>
<p>As stated earlier, a handler is a function accepts a
<code class="docutils literal notranslate"><span class="pre">Psr\Http\Message\RequestInterface</span></code> and array of request options and returns
a <code class="docutils literal notranslate"><span class="pre">GuzzleHttp\Promise\PromiseInterface</span></code> that is fulfilled with a
<code class="docutils literal notranslate"><span class="pre">Psr\Http\Message\ResponseInterface</span></code> or rejected with an exception.</p>
<p>A handler is responsible for applying the following <a class="reference internal" href="request-options.html"><span class="doc">Request Options</span></a>.
These request options are a subset of request options called
“transfer options”.</p>
<ul class="simple">
<li><p><a class="reference internal" href="request-options.html#cert-option"><span class="std std-ref">cert</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#connect-timeout-option"><span class="std std-ref">connect_timeout</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#debug-option"><span class="std std-ref">debug</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#delay-option"><span class="std std-ref">delay</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#decode-content-option"><span class="std std-ref">decode_content</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#expect-option"><span class="std std-ref">expect</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#proxy-option"><span class="std std-ref">proxy</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#sink-option"><span class="std std-ref">sink</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#timeout-option"><span class="std std-ref">timeout</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#ssl-key-option"><span class="std std-ref">ssl_key</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#stream-option"><span class="std std-ref">stream</span></a></p></li>
<li><p><a class="reference internal" href="request-options.html#verify-option"><span class="std std-ref">verify</span></a></p></li>
</ul>
</section>
</section>


          </div>
            
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Neo4j PHP Client and Driver</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Handlers and Middleware</a></li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2022, Ghlen Nagels. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>